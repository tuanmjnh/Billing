
@{
    ViewBag.Title = "Xử lý chung";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<h3 class="col-md-12">Xử lý chung</h3>
<br /><br />
<form action="@Url.Action("Upload")" met method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <div class="col-md-6">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Tùy chọn thông số</h3>
            </div>
            <div class="panel-body">
                <div class="col-md-12 row">
                    <h4 class="form-group col-md-12">Tháng thực hiện</h4>
                    <div class="form-group col-md-12">
                        <label for="ckhMerginMonth">
                            <input type="checkbox" id="ckhMerginMonth" checked /><!--name="ckhMerginMonth" value="1"-->
                            Ghép theo tháng hiện tại
                        </label>
                    </div>
                    <div class="col-md-12">
                        <label class="col-md-6 row">Chọn tháng</label>
                        <div class="col-md-6">
                            <select id="time" class="form-control" name="time">
                                @foreach (var item in (List<string>)ViewBag.directory)
                                {
                                    <option value="@item">@item</option>
                                }
                            </select>
                            <label id="lblTime"></label>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 row">
                    <h4 class="form-group col-md-12">Tải tệp</h4>
                    <div class="form-group col-md-12 asterisk">
                        <label for="FileUpload" class="btn btn-warning">
                            Chọn File
                            <input type="file" id="FileUpload" name="FileUpload" class="file-upload hidden" multiple data-val="true"
                                   data-val-required="Vui lòng chọn file" data-rule-extension="dbf" data-msg-extension="Định dạng tệp phải là dbf." />
                            <span class="field-validation-valid text-danger" data-valmsg-for="FileUpload" data-valmsg-replace="true"></span>
                        </label>
                        <a id="btnUpload" href="javascript:;" class="btn btn-primary">Tải File lên hệ thống</a>
                    </div>
                    <div class="form-group col-md-12 lblUpload"></div>
                </div>
            </div>
        </div>
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Xử lý thanh toán trước</h3>
            </div>
            <div class="panel-body">
                <div class="col-md-12">
                    <div class="form-group"><a id="XuLyThanhToanTruoc" href="javascript:;" class="btn btn-default">Xử lý thanh toán trước</a></div>
                    <label>Tên tệp: <span class="text-danger">thanhtoantruoc.dbf</span></label>
                </div>
            </div>
        </div>
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Xử lý thuê bao tích hợp</h3>
            </div>
            <div class="panel-body">
                <h4 class="col-md-12">Nhập từ PTTB và Xử lý tích hợp</h4>
                <div class="col-md-12">
                    <div class="form-group"><a id="LayTichHop" href="javascript:;" class="btn btn-default">1. Lấy danh sách biến động tích hợp</a></div>
                    <div class="form-group"><a id="XuLyTichHop" href="javascript:;" class="btn btn-default">2. Xử lý biến động tích hợp</a></div>
                </div>
                <div class="hr hr-danger"></div>
                <h4 class="col-md-12">Nhập thêm tích hợp</h4>
                <div class="col-md-12 form-group">
                    <textarea rows="5" class="form-control" id="data_value" name="data_value" data-val="true" data-val-required="Vui lòng nhập giá trị"></textarea>
                    <span class="field-validation-valid text-danger" data-valmsg-for="data_value" data-valmsg-replace="true"></span>
                </div>
                <div class="col-md-12 form-group">
                    <div class="form-group"><a id="XuLyNhapThemTichHop" href="javascript:;" class="btn btn-default">Nhập thêm tích hợp</a></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Nhập Fix - Ghép cước tháng</h3>
            </div>
            <div class="panel-body">
                <div class="col-md-12">
                    <h4>Nhập Fix cước</h4>
                    <div class="form-group"><a id="XuLyFixCuocMegaVNN" href="javascript:;" class="btn btn-default XuLyFixMergin" data-val="@((int)Billing.Common.Objects.TYPE_BILL.FIX_MEGAVNN)">Fix cước MegaVNN</a></div>
                    <div class="form-group"><a id="XuLyFixCuocFiberVNN" href="javascript:;" class="btn btn-default XuLyFixMergin" data-val="@((int)Billing.Common.Objects.TYPE_BILL.FIX_FIBERVNN)">Fix cước FiberVNN</a></div>
                    <div class="form-group"><a id="XuLyFixCuocMyTV" href="javascript:;" class="btn btn-default XuLyFixMergin" data-val="@((int)Billing.Common.Objects.TYPE_BILL.FIX_MYTV)">Fix cước MyTV</a></div>
                    <br />
                    <label>Tên tệp NET: <span class="text-danger">@(Billing.Common.Objects.TYPE_BILL.FIX_MEGAVNN.ToString().ToLower()).dbf</span></label>
                    <br />
                    <label>Tên tệp NET: <span class="text-danger">@(Billing.Common.Objects.TYPE_BILL.FIX_FIBERVNN.ToString().ToLower()).dbf</span></label>
                    <br />
                    <label>Tên tệp MyTV: <span class="text-danger">@(Billing.Common.Objects.TYPE_BILL.FIX_MYTV.ToString().ToLower()).dbf</span></label>
                </div>
                <div class="hr hr-danger"></div>
                <div class="col-md-12">
                    <h4>Nhập Ghép cước</h4>
                    <div class="form-group"><a id="XuLyGhepCuocMegaVNN" href="javascript:;" class="btn btn-default XuLyFixMergin" data-val="@((int)Billing.Common.Objects.TYPE_BILL.MERGIN_MEGAVNN)">Ghép cước MegaVNN</a></div>
                    <div class="form-group"><a id="XuLyGhepCuocFiberVNN" href="javascript:;" class="btn btn-default XuLyFixMergin" data-val="@((int)Billing.Common.Objects.TYPE_BILL.MERGIN_FIBERVNN)">Ghép cước FiberVNN</a></div>
                    <div class="form-group"><a id="XuLyGhepCuocMyTV" href="javascript:;" class="btn btn-default XuLyFixMergin" data-val="@((int)Billing.Common.Objects.TYPE_BILL.MERGIN_MYTV)">Ghép cước MyTV</a></div>
                    <br />
                    <label>Tên tệp NET: <span class="text-danger">@(Billing.Common.Objects.TYPE_BILL.MERGIN_MEGAVNN.ToString().ToLower()).dbf</span></label>
                    <br />
                    <label>Tên tệp NET: <span class="text-danger">@(Billing.Common.Objects.TYPE_BILL.MERGIN_FIBERVNN.ToString().ToLower()).dbf</span></label>
                    <br />
                    <label>Tên tệp MyTV: <span class="text-danger">@(Billing.Common.Objects.TYPE_BILL.MERGIN_MYTV.ToString().ToLower()).dbf</span></label>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="clearfix"></div>
@section scripts {
    <script>
        AjaxLoad();
        function MerginMonth() {
            if ($('#ckhMerginMonth').prop('checked') == true) {
                var date = moment();
                var month = parseInt(date.format('MM')) - 1;
                month = month < 10 ? '0' + month : month + '';
                var year = date.format('YYYY');
                $('select[name="time"]').hide();
                $('#lblTime').html(year + month).show();
            } else {
                $('select[name="time"]').show();
                $('#lblTime').hide();
            }
        };
        $(function () {
            MerginMonth();
        });
        $('#ckhMerginMonth').on('click', function () {
            MerginMonth();
        });
        $('#FileUpload').on('change', function () {
            var files = this.files;
            var html = '';
            for (var i = 0; i < files.length; i++) {
                html += '<span class="text-primary">' + (i + 1) + '. ' + files[i].name + '</span><br/>';
            }
            $('.lblUpload').html(html);
        });
        function ActionLink(obj) {
            obj.e.preventDefault();
            var formdata = new FormData($('form')[0]);
            for (var i in obj.data)
                formdata.append(i, obj.data[i]);
            //obj.data = $.extend({}, { '__RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }, obj.data);
            $.ajax({
                url: obj.url,
                type: 'POST',
                dataType: 'json',
                data: formdata,
                cache: false,
                contentType: false,
                processData: false,
                success: function (d) {
                    if (d.success)
                        $('#TMAlert').TMAlert({ type: "success", message: d.success });
                    if (d.danger)
                        $('#TMAlert').TMAlert({ type: "danger", message: d.danger });
                    $('#FileUpload').val('');
                    $('.lblUpload').html('');
                },
                error: function (xhr, error, status) {
                    console.log(error, status);
                }
            });
        };
        //GeneralUpload
        $('#btnUpload').on('click', function (e) {
            ActionLink({
                e: e,
                url: '@Url.Action("GeneralUpload")',
                data: { time: $('#time').val(), ckhMerginMonth: $('#ckhMerginMonth').prop('checked'), file:'ThanhToanTruoc' }
            });
        });
        //Xử lý thanh toán trước
        $('#XuLyThanhToanTruoc').on('click', function (e) {
            ActionLink({
                e: e,
                url: '@Url.Action("XuLyThanhToanTruoc")',
                data: { time: $('#time').val(), ckhMerginMonth: $('#ckhMerginMonth').prop('checked') }
            });
        });
        //Lấy danh sách biến động tích hợp
        $('#LayTichHop').on('click', function (e) {
            ActionLink({
                e: e,
                url: '@Url.Action("LayTichHop")',
                data: { time: $('#time').val(), ckhMerginMonth: $('#ckhMerginMonth').prop('checked') }
            });
        });
        //Xử lý biến động tích hợp
        $('#XuLyTichHop').on('click', function (e) {
            ActionLink({
                e: e,
                url: '@Url.Action("XuLyTichHop")',
                data: { time: $('#time').val(), ckhMerginMonth: $('#ckhMerginMonth').prop('checked') }
            });
        });
        //Nhập thêm tích hợp
        $('#XuLyNhapThemTichHop').on('click', function (e) {
            ActionLink({
                e: e,
                url: '@Url.Action("XuLyNhapThemTichHop")',
                data: { time: $('#time').val(), ckhMerginMonth: $('#ckhMerginMonth').prop('checked') }
            });
        });
        //Fix cước MegaVNN
        $('.XuLyFixMergin').on('click', function (e) {
            ActionLink({
                e: e,
                url: '@Url.Action("XuLyFixMerginCuoc")',
                data: { time: $('#time').val(), ckhMerginMonth: $('#ckhMerginMonth').prop('checked'), type_id: $(this).attr('data-val') }
            });
        });
    </script>
}