@{
    ViewBag.Title = "Xuất file DBF";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<h3 class="col-md-12 panel-title">Xuất file DBF</h3>
<br /><br />
<form action="@Url.Action("Upload")" met method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <div class="col-md-8">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Danh sách bảng</h3>
            </div>
            <div class="panel-body">
                <div id="tableList"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Xử lý chung</h3>
            </div>
            <div class="panel-body">
                <h4>Tùy chọn</h4>
                <div class="form-group">
                    <label class="col-md-4">Chọn tháng</label>
                    <div class="col-md-8">
                        <select id="time" class="form-control" name="time">
                            @foreach (var item in (List<string>)ViewBag.directory)
                            {
                                <option value="@item">@item</option>
                            }
                        </select>
                        <label id="lblTime"></label>
                    </div>
                </div>
                @*<div class="form-group">
                        <label class="col-md-12" for="ckhMerginMonth">
                            <input type="checkbox" id="ckhMerginMonth" name="ckhMerginMonth" />
                            Ghép theo tháng hiện tại
                        </label>
                    </div>*@
                <div class="form-group">
                    <label class="col-md-12" for="ckhMerginMonth">
                        <input type="checkbox" id="ckhMerginMonth" checked /><!--name="ckhMerginMonth" value="1"-->
                        Ghép theo tháng hiện tại
                    </label>
                </div>
            </div>
        </div>
    </div>
</form>
<div class="clearfix"></div>
<!-- Modal -->
<div class="modal stat" id="ModalUpdateTable" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Cập nhật thông tin bảng xuất DBF</h4>
            </div>
            <div class="modal-body">
                <div id="TableDetail"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Quay lại</button>
            </div>
        </div>
    </div>
</div>
@section scripts {
    <script>
        AjaxLoad();
        function MerginMonth() {
            if ($('#ckhMerginMonth').prop('checked') == true) {
                var date = moment();
                var month = parseInt(date.format('MM')) - 1;
                month = month < 10 ? '0' + month : month + '';
                var year = date.format('YYYY');
                $('select[name="time"]').hide();
                $('#lblTime').html(year + month).show();
            } else {
                $('select[name="time"]').show();
                $('#lblTime').hide();
            }
        };
        $(function () {
            MerginMonth();
            GetTables();
            $('#TableDetail').TMUpdateValue({ url: '@Url.Action("UpdateTableExport")', data: { '__RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() } });
        });
        $('#ckhMerginMonth').on('click', function () {
            MerginMonth();
        });
        function ActionLink(obj) {
            obj.e.preventDefault();
            var formdata = new FormData($('form')[0]);
            //if($('#ckhMerginMonth').prop('checked') == true)
            //    formdata.append('ckhMerginMonth', true);
            // else
            //    formdata.append('ckhMerginMonth', false);
            for (var i in obj.data) 
                formdata.append(i, obj.data[i]);

            //obj.data = $.extend({}, { '__RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() }, obj.data);
            $.ajax({
                url: obj.url,
                type: 'POST',
                dataType: 'json',
                data: formdata,
                cache: false,
                contentType: false,
                processData: false,
                success: function (d) {
                    if (d.success)
                        $('#TMAlert').TMAlert({ type: "success", message: d.success });
                    if (d.danger)
                        $('#TMAlert').TMAlert({ type: "danger", message: d.danger });
                    if (d.warning)
                        $('#TMAlert').TMAlert({ type: "warning", message: d.warning });
                },
                error: function (xhr, error, status) {
                    console.log(error, status);
                }
            });
        };
        //Get Tables
        function GetTables() {
            $.get('@Url.Action("GetTableList")', function (d) {
                if (d.data) {
                    var html = '<table class="table table-bordered table-hover table-responsive">' +
                        '<tr><th>Tên bảng</th><th class="col-md-1">#</th><th class="col-md-1">#</th></tr>';
                    for (var i = 0; i < d.data.length; i++) {
                        html += '<tr data-id="' + d.data[i].TABLE_NAME+'"><td>' + d.data[i].TABLE_NAME + '</td>' +
                                '<td><span class="btn btn-success pointer btnExportToDBF" alt="Xuất file DBF"><i class="fa fa-refresh fa-spin"></i></span></td>'+
                                '<td><span class="btn btn-primary pointer btnUpdateTable" alt="Cấu hình"><i class="fa fa-cog fa-spin" aria-hidden="true"></i></span></td></tr>';
                    }
                    html +='</table>';
                    $('#tableList').html(html);
                }
                if (d.danger)
                    $('#TMAlert').TMAlert({ type: "danger", message: d.danger });
                if (d.warning)
                    $('#TMAlert').TMAlert({ type: "warning", message: d.warning });
            })
        };
        //Update Table
        $(document).on('click', '.btnUpdateTable', function () {
            var table = $(this).parent().prev().prev().html();
            var data = { '__RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val(), tableName: table };
            $.post('@Url.Action("GetDetailsTableExport")', data, function (d) {
                if (d.data) {
                    $('#ModalUpdateTable').modal('show');
                    var html = '<table class="table table-bordered table-hover table-responsive"><thead><tr>' +
                        '<th>NAME</th>' +
                        '<th>TYPE</th>' +
                        '<th>LENGTH</th>' +
                        '<th>NAME_EXPORT</th>' +
                        '<th>TYPE_EXPORT</th>' +
                        '<th>LENGTH_EXPORT</th>' +
                        '<th>CONDITION</th>' +
                        '<th>ORDERS</th>' +
                        '<th class="col-md-1">FLAG</th></tr></thead><tbody>';
                    for (var i = 0; i < d.data.length; i++) {
                        html += '<tr data-id="' + d.data[i].ID + '"><td>' + d.data[i].COLUMN_NAME + '</td>' +
                            '<td>' + d.data[i].COLUMN_TYPE + '</td>' +
                            '<td>' + d.data[i].COLUMN_LENGTH + '</td>' +
                            '<td tm-editable="true" data-val="COLUMN_NAME_EXPORT" maxlength="11">' + d.data[i].COLUMN_NAME_EXPORT + '</td>' +
                            '<td tm-editable="true" data-val="COLUMN_TYPE_EXPORT">' + d.data[i].COLUMN_TYPE_EXPORT + '</td>' +
                            '<td tm-editable="true" data-val="COLUMN_LENGTH_EXPORT">' + d.data[i].COLUMN_LENGTH_EXPORT + '</td>' +
                            '<td tm-editable="true" data-val="CONDITION">' + d.data[i].CONDITION + '</td>' +
                            '<td tm-editable="true" data-val="ORDERS">' + d.data[i].ORDERS + '</td>' +
                            '<td tm-editable="true" tm-editable-type="checkbox" data-val="FLAG">' + d.data[i].FLAG + '</td></tr>';
                    };
                    html += '</tbody></table>';
                    $('#TableDetail').html(html);
                }
                if (d.danger)
                    $('#TMAlert').TMAlert({ type: "danger", message: d.danger });
                if (d.warning)
                    $('#TMAlert').TMAlert({ type: "warning", message: d.warning });
            });
        });
        //Export Table To DBF
        $(document).on('click', '.btnExportToDBF', function (e) {
            ActionLink({
                e: e,
                url: '@Url.Action("ExportToDBF")',
                data: { time: $('#time').val(), ckhMerginMonth: $('#ckhMerginMonth').prop('checked'), file: $(this).parents('tr').attr('data-id') }
            });
        });
        @*$(document).on('click', '.btnExportToDBF', function (e) {
            var table = $(this).parents('tr').attr('data-id');
            var data = { '__RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val(), tableName: table };
            $.post('@Url.Action("ExportToDBF")', data, function (d) {
                if (d.success)
                    $('#TMAlert').TMAlert({ type: "success", message: d.success });
                if (d.danger)
                    $('#TMAlert').TMAlert({ type: "danger", message: d.danger });
            });
        });*@
    </script>
}